<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <title>Robot Control</title>
</head>
<body class="bg-gray-950 text-gray-100">
  <div class="max-w-5xl mx-auto p-6 space-y-6">
    <header class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-semibold">Robot Arm Dashboard</h1>
        <p class="text-sm text-gray-400">Estado: <span id="conn" class="text-yellow-300">DESCONOCIDO</span></p>
      </div>
      <div class="flex gap-3">
        <button id="masterArm" class="px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-500">ARM ALL</button>
        <button id="estop" class="px-4 py-2 rounded-xl bg-red-600 hover:bg-red-500 font-semibold">STOP</button>
      </div>
    </header>

    <section class="bg-gray-900/60 rounded-2xl p-4 border border-gray-800">
      <div class="grid grid-cols-12 gap-3 text-xs text-gray-400 mb-2">
        <div class="col-span-2">ARM</div>
        <div class="col-span-3">Motor</div>
        <div class="col-span-5">Grados</div>
        <div class="col-span-2 text-right">Valor</div>
      </div>
      <div id="motors" class="space-y-3"></div>
    </section>
  </div>

<script>
  // Config base
  const motors = [
    { ch:0, name:"Base (MG996)",      min:0,  max:180, deg:90, armed:false },
    { ch:1, name:"Antebrazo (MG996)", min:0,  max:180, deg:90, armed:false },
    { ch:2, name:"Brazo (MG996)",     min:0,  max:180, deg:90, armed:false },
    { ch:3, name:"Muñeca tilt (SG90)",min:0,  max:180, deg:90, armed:false },
    { ch:4, name:"Giro garra (SG90)", min:0,  max:180, deg:90, armed:false },
    { ch:5, name:"Apertura garra (SG90)", min:15, max:90,  deg:45, armed:false }, // clamp especial
  ];

  const elMotors = document.getElementById("motors");
  const clamp = (v,min,max)=> Math.max(min, Math.min(max, v));

  function enableMask(){
    return motors.reduce((mask,m)=> mask | ((m.armed?1:0) << m.ch), 0);
  }

  // En el siguiente paso esto se vuelve WS send()
  function send(msg){
    console.log("SEND", msg);
  }

  function render(){
    elMotors.innerHTML = "";
    motors.forEach((m, idx)=>{
      const row = document.createElement("div");
      row.className = "grid grid-cols-12 gap-3 items-center";

      row.innerHTML = `
        <div class="col-span-2">
          <label class="inline-flex items-center gap-2 cursor-pointer select-none">
            <input type="checkbox" ${m.armed ? "checked":""} data-idx="${idx}" class="armToggle h-4 w-4">
            <span class="${m.armed ? "text-green-300":"text-gray-400"}">${m.armed ? "ARMED":"SAFE"}</span>
          </label>
        </div>

        <div class="col-span-3 text-sm">${m.name}</div>

        <div class="col-span-5">
          <input type="range" min="${m.min}" max="${m.max}" value="${m.deg}"
            data-idx="${idx}"
            class="degSlider w-full ${m.armed ? "":"opacity-40 pointer-events-none"}" />
          <div class="text-xs text-gray-500 mt-1">min ${m.min}° / max ${m.max}°</div>
        </div>

        <div class="col-span-2 text-right">
          <input type="number" min="${m.min}" max="${m.max}" value="${m.deg}"
            data-idx="${idx}"
            class="degInput w-20 bg-gray-950 border border-gray-800 rounded-lg px-2 py-1 text-sm ${m.armed ? "":"opacity-40 pointer-events-none"}" />
        </div>
      `;
      elMotors.appendChild(row);
    });

    // listeners
    document.querySelectorAll(".armToggle").forEach(inp=>{
      inp.onchange = (e)=>{
        const idx = +e.target.dataset.idx;
        motors[idx].armed = e.target.checked;

        // Cuando cambie el mask, lo mandamos
        send({ type:"set_enable_mask", mask: enableMask() });
        render();
      };
    });

    const onDegChange = (idx, value)=>{
      const m = motors[idx];
      const v = clamp(+value, m.min, m.max);
      m.deg = v;

      // Solo manda si está armado
      if(m.armed){
        send({ type:"set_servo", ch: m.ch, deg: v });
      }
      render();
    };

    document.querySelectorAll(".degSlider").forEach(inp=>{
      inp.oninput = (e)=> onDegChange(+e.target.dataset.idx, e.target.value);
    });
    document.querySelectorAll(".degInput").forEach(inp=>{
      inp.onchange = (e)=> onDegChange(+e.target.dataset.idx, e.target.value);
    });
  }

  document.getElementById("masterArm").onclick = ()=>{
    const anyDisarmed = motors.some(m=>!m.armed);
    motors.forEach(m=> m.armed = anyDisarmed); // si hay alguno apagado → enciende todos, si no → apaga todos
    send({ type:"set_enable_mask", mask: enableMask() });
    render();
  };

  document.getElementById("estop").onclick = ()=>{
    send({ type:"estop" });
  };

  render();
</script>
</body>
</html>