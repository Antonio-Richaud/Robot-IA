<!doctype html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Tipos limpios -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&family=JetBrains+Mono:wght@500;600&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="./styles.css" />
    <title>Robot V1</title>
</head>

<body>
    <main class="wrap">
        <!-- Top bar -->
        <header class="top">
            <div class="titleBlock">
                <div class="title">Robot V1</div>
                <div class="status" id="connBadge">
                    <span class="dot dot--warn" id="connDot"></span>
                    <span id="connText">DISCONNECTED</span>
                </div>
            </div>

            <div class="actions">
                <button id="masterArm" class="btn btn--primary">ARM ALL</button>
                <button id="estop" class="btn btn--danger">STOP</button>
            </div>
        </header>

        <section class="layout">
            <!-- Left: Motors -->
            <section class="card">
                <div class="cardHead">
                    <div class="cardTitle">Motor Control</div>
                    <div class="cardNote mono">CH0..CH5 • Servo6 clamp: 15–90°</div>
                </div>

                <div class="tableHead">
                    <div>ARM</div>
                    <div>MOTOR</div>
                    <div>DEGREES</div>
                    <div class="right">VAL</div>
                </div>

                <div id="motors" class="rows"></div>

                <div class="footerNote mono">
                    Tip: arma solo lo que estés usando. Desarmado = no manda comandos.
                </div>
            </section>

            <!-- Right: System -->
            <aside class="card">
                <div class="cardHead">
                    <div class="cardTitle">System</div>
                    <div class="cardNote mono">JSON</div>
                </div>

                <div class="kv">
                    <div class="k">Enable Mask</div>
                    <div class="v mono">0b<span id="maskBin">000000</span> <span class="muted">(</span><span
                            id="maskDec">0</span><span class="muted">)</span></div>
                </div>

                <div class="kv">
                    <div class="k">Last TX</div>
                    <div class="v mono ellipsis" id="lastCmd">—</div>
                </div>

                <div class="kv">
                    <div class="k">Last RX</div>
                    <div class="v mono ellipsis" id="lastRx">—</div>
                </div>

                <div class="logHead">
                    <div class="mono">LOG</div>
                    <div class="logActions">
                        <button id="clearLog" class="btn btn--ghost">CLEAR</button>
                    </div>
                </div>
                <div id="log" class="log mono"></div>

                <div class="footerNote mono">
                    Pendiente: conectar WebSocket (relay) para RX real.
                </div>
            </aside>
        </section>
    </main>

    <script>
        // =========================
        // CONFIG / STATE
        // =========================
        const motors = [
            { ch: 0, name: "Base (MG996)", min: 0, max: 180, deg: 90, armed: false },
            { ch: 1, name: "Antebrazo (MG996)", min: 0, max: 180, deg: 90, armed: false },
            { ch: 2, name: "Brazo (MG996)", min: 0, max: 180, deg: 90, armed: false },
            { ch: 3, name: "Muñeca inclinación (SG90)", min: 0, max: 180, deg: 90, armed: false },
            { ch: 4, name: "Giro garra (SG90)", min: 0, max: 180, deg: 90, armed: false },
            { ch: 5, name: "Apertura garra (SG90)", min: 15, max: 90, deg: 45, armed: false }, // clamp especial
        ];

        const $ = (id) => document.getElementById(id);
        const elMotors = $("motors");
        const elLog = $("log");

        const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
        const bin6 = (n) => n.toString(2).padStart(6, "0");

        function enableMask() {
            return motors.reduce((mask, m) => mask | ((m.armed ? 1 : 0) << m.ch), 0);
        }

        function updateMaskUI() {
            const mask = enableMask();
            $("maskBin").textContent = bin6(mask);
            $("maskDec").textContent = mask;
        }

        function setConn(state) {
            // state: "OK" | "BAD" | "UNK"
            const dot = $("connDot");
            const txt = $("connText");

            dot.classList.remove("dot--ok", "dot--warn", "dot--bad");
            if (state === "OK") {
                dot.classList.add("dot--ok");
                txt.textContent = "CONNECTED";
            } else if (state === "BAD") {
                dot.classList.add("dot--bad");
                txt.textContent = "DISCONNECTED";
            } else {
                dot.classList.add("dot--warn");
                txt.textContent = "UNKNOWN";
            }
        }

        function escapeHtml(str) {
            return str
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;");
        }

        function logLine(type, obj) {
            const t = new Date().toLocaleTimeString();
            const line = document.createElement("div");
            line.className = "logline " + (type === "TX" ? "tx" : type === "RX" ? "rx" : "sys");
            line.innerHTML = `<span class="tag">${type}</span><span class="time">${t}</span> ${escapeHtml(JSON.stringify(obj))}`;
            elLog.prepend(line);
        }

        // =========================
        // TRANSPORT LAYER (stub)
        // =========================
        function send(msg) {
            // UI safety
            if (msg.type === "set_servo") {
                const m = motors[msg.ch];
                if (!m?.armed) return;
                msg.deg = clamp(+msg.deg, m.min, m.max);
            }
            if (msg.type === "set_pose" && Array.isArray(msg.deg)) {
                msg.deg = msg.deg.map((d, ch) => clamp(+d, motors[ch].min, motors[ch].max));
            }

            $("lastCmd").textContent = JSON.stringify(msg);
            logLine("TX", msg);

            // TODO: ws.send(JSON.stringify(msg))
        }

        // Cuando tengas WS:
        // function handleRx(msg){
        //   $("lastRx").textContent = JSON.stringify(msg);
        //   logLine("RX", msg);
        //   if(msg.type === "status"){ ...sync... }
        // }

        // =========================
        // RENDER
        // =========================
        function renderMotors() {
            elMotors.innerHTML = "";

            motors.forEach((m, idx) => {
                const row = document.createElement("div");
                row.className = "row";

                row.innerHTML = `
        <div class="cell">
          <label class="toggle ${m.armed ? "armed" : "safe"}">
            <input type="checkbox" ${m.armed ? "checked" : ""} data-idx="${idx}" class="armToggle" />
            <span class="track"><span class="thumb"></span></span>
            <span class="ttext mono">${m.armed ? "ARM" : "SAFE"}</span>
          </label>
        </div>

        <div class="cell">
          <div class="mname">${m.name}</div>
          <div class="mmeta mono">CH${m.ch} • ${m.min}–${m.max}°</div>
        </div>

        <div class="cell">
          <input type="range" min="${m.min}" max="${m.max}" value="${m.deg}" data-idx="${idx}"
            class="slider ${m.armed ? "" : "disabled"}" />
        </div>

        <div class="cell right">
          <input type="number" min="${m.min}" max="${m.max}" value="${m.deg}" data-idx="${idx}"
            class="num mono ${m.armed ? "" : "disabled"}" />
          <button class="btn btn--ghost btn--micro centerBtn" data-idx="${idx}">90°</button>
        </div>
      `;

                elMotors.appendChild(row);
            });

            // ARM toggles
            document.querySelectorAll(".armToggle").forEach(inp => {
                inp.onchange = (e) => {
                    const idx = +e.target.dataset.idx;
                    motors[idx].armed = e.target.checked;
                    updateMaskUI();
                    send({ type: "set_enable_mask", mask: enableMask() });
                    renderMotors();
                };
            });

            const onDegChange = (idx, value) => {
                const m = motors[idx];
                m.deg = clamp(+value, m.min, m.max);
                renderMotors();
                if (m.armed) {
                    send({ type: "set_servo", ch: m.ch, deg: m.deg });
                }
            };

            document.querySelectorAll(".slider").forEach(inp => {
                inp.oninput = (e) => onDegChange(+e.target.dataset.idx, e.target.value);
            });

            document.querySelectorAll(".num").forEach(inp => {
                inp.onchange = (e) => onDegChange(+e.target.dataset.idx, e.target.value);
            });

            document.querySelectorAll(".centerBtn").forEach(btn => {
                btn.onclick = (e) => onDegChange(+e.target.dataset.idx, 90);
            });
        }

        // =========================
        // ACTIONS
        // =========================
        $("masterArm").onclick = () => {
            const anyDisarmed = motors.some(m => !m.armed);
            motors.forEach(m => m.armed = anyDisarmed);
            updateMaskUI();
            send({ type: "set_enable_mask", mask: enableMask() });
            renderMotors();
        };

        $("estop").onclick = () => {
            send({ type: "estop" });
        };

        $("clearLog").onclick = () => {
            elLog.innerHTML = "";
            logLine("SYS", { info: "log cleared" });
        };

        // Hotkeys
        document.addEventListener("keydown", (e) => {
            if (e.key.toLowerCase() === "q") $("masterArm").click();
            if (e.key === "Escape") $("estop").click();
        });

        // =========================
        // INIT
        // =========================
        function init() {
            setConn("BAD"); // hasta que WS diga lo contrario
            updateMaskUI();
            renderMotors();
            logLine("SYS", { boot: "ok", note: "All motors start SAFE (disarmed)." });
        }
        init();
    </script>
</body>

</html>